name: Prove blocks
on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
    prepare:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - id: variables
              run: |
                LATEST_RANGE_FILE=$( ls assets/proofs/* | sort -r | head -n 1 )
                LATEST_BLOCK=$( jq 'keys|last|tonumber' $LATEST_RANGE_FILE )
                BLOCK=$( curl -H "project_id: ${{secrets.BLOCKFROST_API_KEY}}" https://cardano-preprod.blockfrost.io/api/v0/blocks/latest | jq -r '.height' )
                BLOCK_SAMPLING=100
                BLOCK_PER_BATCH=100
                BATCH_SIZE=$(( ($BLOCK - $BLOCK % $BLOCK_SAMPLING) * $BLOCK_SAMPLING ))
                #BLOCK_COUNT=$( $TIP > b ? $TIP : b )

                echo "batch=${BATCH}" >> "$GITHUB_OUTPUT"
                echo "block=${BLOCK}" >> "$GITHUB_OUTPUT"
                echo "blocks=[${BLOCK}]" >> "$GITHUB_OUTPUT"
        outputs:
            batch: ${{ steps.variables.outputs.batch }}
            block: ${{ steps.variables.outputs.block }}
            blocks: ${{ steps.variables.outputs.blocks }}

    prove:
        runs-on: ubuntu-latest
        needs: prepare
        strategy:
            matrix:
                prover: [risc0]
                block: ${{ fromJson(needs.prepare.outputs.blocks) }}
        defaults:
            run:
                working-directory: provers/${{ matrix.prover }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - run: rustup toolchain install stable --profile minimal

            - uses: Swatinem/rust-cache@v2
              with:
                workspaces: provers/${{ matrix.prover }} -> provers/${{ matrix.prover }}/target

            - name: Setup
              run: make setup
              shell: bash

            - name: Prove
              run: |
                export RAW_BLOCK=$(curl -H "project_id: ${{secrets.BLOCKFROST_API_KEY}}" "https://cardano-preprod.blockfrost.io/api/v0/blocks/${{ needs.prepare.outputs.block }}/cbor" | jq -r '.cbor')
                RESULT=`make prove`
                FILE="../../assets/proofs/${{needs.prepare.outputs.batch}}.json"
                
                git pull # Make sure we work on uptodate files
                # Create an empty JSON file the first time
                mkdir -p $(dirname ${FILE}) 
                echo "{}" > ${FILE}
                # Update the JSON with new proof
                cat <<< $(jq '."${{ needs.prepare.outputs.block }}".proofs.${{ matrix.prover }}="${RESULT}"' ${FILE}) > ${FILE}
              shell: bash

            - name: Commit changes
              env: 
                CI_COMMIT_MESSAGE: "chore: added proof for block ${{ needs.prepare.outputs.block }}"
                CI_COMMIT_AUTHOR: Continuous Proving
              run: |
                git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
                git config --global user.email "username@users.noreply.github.com"
                git add ../../assets/proofs/${{needs.prepare.outputs.batch}}.json
                git commit -m "${{ env.CI_COMMIT_MESSAGE }}"
                git push